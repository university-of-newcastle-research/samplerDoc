<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Estimating the Marginal Likelihood via Importance Sampling (IS2) | Particle Based Samplers for MCMC</title>
  <meta name="description" content="Particle Based Sampler for MCMC" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Estimating the Marginal Likelihood via Importance Sampling (IS2) | Particle Based Samplers for MCMC" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Particle Based Sampler for MCMC" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Estimating the Marginal Likelihood via Importance Sampling (IS2) | Particle Based Samplers for MCMC" />
  
  <meta name="twitter:description" content="Particle Based Sampler for MCMC" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"/>
<link rel="next" href="troubleshoot.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">PMwG Samplers Package</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction to particle based sampler for MCMC</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#assumed-knowledge"><i class="fa fa-check"></i><b>1.1</b> Assumed knowledge</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#why-would-you-use-particle-metropolis-within-gibbs-sampling"><i class="fa fa-check"></i><b>1.2</b> Why would you use Particle Metropolis within Gibbs sampling?</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#the-assumed-hierarchical-structure"><i class="fa fa-check"></i><b>1.3</b> The assumed hierarchical structure</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#what-particle-metropolis-within-gibbs-sampling-provides"><i class="fa fa-check"></i><b>1.4</b> What Particle Metropolis within Gibbs sampling provides</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#what-is-particle-metropolis-within-gibbs-sampling"><i class="fa fa-check"></i><b>1.5</b> What is Particle Metropolis within Gibbs sampling?</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#generating-proposals-in-pmwg-sampling-using-particle-metropolis"><i class="fa fa-check"></i><b>1.6</b> Generating proposals in PMwG sampling using Particle Metropolis</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html"><i class="fa fa-check"></i><b>2</b> PMwG sampler and Signal Detection Theory</a>
<ul>
<li class="chapter" data-level="2.0.1" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#sdtOutline"><i class="fa fa-check"></i><b>2.0.1</b> Signal Detection Theory analysis of lexical decision task</a></li>
<li class="chapter" data-level="2.0.2" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#SDTLLFun"><i class="fa fa-check"></i><b>2.0.2</b> The log-likelihood function</a></li>
<li class="chapter" data-level="2.1" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#testing-the-sdt-log-likelihood-function"><i class="fa fa-check"></i><b>2.1</b> Testing the SDT log-likelihood function</a></li>
<li class="chapter" data-level="2.2" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#sdtWag"><i class="fa fa-check"></i><b>2.2</b> SDT log-likelihood function for Wagenmakers experiment</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#description-of-wagenmakers-experiment"><i class="fa fa-check"></i><b>2.2.1</b> Description of Wagenmakers experiment</a></li>
<li class="chapter" data-level="2.2.2" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#computation-time-of-the-log-likelihood-function"><i class="fa fa-check"></i><b>2.2.2</b> Computation time of the log-likelihood function</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#sdtPMwG"><i class="fa fa-check"></i><b>2.3</b> PMwG Framework</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#start-points"><i class="fa fa-check"></i><b>2.3.1</b> Model start points</a></li>
<li class="chapter" data-level="2.3.2" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#run-sdtsampler"><i class="fa fa-check"></i><b>2.3.2</b> Running the sampler</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#check-the-sampling-process"><i class="fa fa-check"></i><b>2.4</b> Check the sampling process</a></li>
<li class="chapter" data-level="2.5" data-path="pmwg-sampler-and-signal-detection-theory.html"><a href="pmwg-sampler-and-signal-detection-theory.html#simulating-posterior-data"><i class="fa fa-check"></i><b>2.5</b> Simulating posterior data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="forstmannChapter.html"><a href="forstmannChapter.html"><i class="fa fa-check"></i><b>3</b> PMwG sampler and sequential sampling models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#the-speed-accuracy-trade-off-in-perceptual-decisions"><i class="fa fa-check"></i><b>3.1</b> The speed-accuracy trade-off in perceptual decisions</a></li>
<li class="chapter" data-level="3.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#LBAParameters"><i class="fa fa-check"></i><b>3.2</b> Linear Ballistic Accumulator Parameters</a></li>
<li class="chapter" data-level="3.3" data-path="forstmannChapter.html"><a href="forstmannChapter.html#theLLFunc"><i class="fa fa-check"></i><b>3.3</b> The log-likelihood function</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#what-is-a-log-likelihood-function"><i class="fa fa-check"></i><b>3.3.1</b> What is a log-likelihood function?</a></li>
<li class="chapter" data-level="3.3.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#writing-the-log-likelihood-function-for-the-forstmann-data-set"><i class="fa fa-check"></i><b>3.3.2</b> Writing the log-likelihood function for the Forstmann data set</a></li>
<li class="chapter" data-level="3.3.3" data-path="forstmannChapter.html"><a href="forstmannChapter.html#fstLBALL"><i class="fa fa-check"></i><b>3.3.3</b> Fast LBA Log-likelihood Function</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="forstmannChapter.html"><a href="forstmannChapter.html#pmwg-framework"><i class="fa fa-check"></i><b>3.4</b> PMwG Framework</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#lbaStartPts"><i class="fa fa-check"></i><b>3.4.1</b> Model start points</a></li>
<li class="chapter" data-level="3.4.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#run-sampler"><i class="fa fa-check"></i><b>3.4.2</b> Running the sampler</a></li>
<li class="chapter" data-level="3.4.3" data-path="forstmannChapter.html"><a href="forstmannChapter.html#estSet"><i class="fa fa-check"></i><b>3.4.3</b> Determining estimation settings for the PMwG sampler</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="forstmannChapter.html"><a href="forstmannChapter.html#genppdatafunc"><i class="fa fa-check"></i><b>3.5</b> Simulating Posterior Predictive Data</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#assessing-descriptive-adequacy-goodness-of-fit"><i class="fa fa-check"></i><b>3.5.1</b> Assessing Descriptive Adequacy (goodness of fit)</a></li>
<li class="chapter" data-level="3.5.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#pmwg-framework-for-a-single-threshold-model"><i class="fa fa-check"></i><b>3.5.2</b> PMwG framework for a single threshold model</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="forstmannChapter.html"><a href="forstmannChapter.html#checking-descriptive-adequacy-of-1b-model."><i class="fa fa-check"></i><b>3.6</b> Checking Descriptive Adequacy of 1b model.</a></li>
<li class="chapter" data-level="3.7" data-path="forstmannChapter.html"><a href="forstmannChapter.html#forstMC"><i class="fa fa-check"></i><b>3.7</b> Model Comparison</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#assessing-descriptive-adequacy-graphically"><i class="fa fa-check"></i><b>3.7.1</b> Assessing Descriptive Adequacy Graphically</a></li>
<li class="chapter" data-level="3.7.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#forstDIC"><i class="fa fa-check"></i><b>3.7.2</b> Model comparison via DIC</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="forstmannChapter.html"><a href="forstmannChapter.html#LBAllcheck"><i class="fa fa-check"></i><b>3.8</b> Checking the LBA log-likelihood function</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#test-one-do-changes-in-parameter-values-cause-changes-in-the-returned-log-likelihood"><i class="fa fa-check"></i><b>3.8.1</b> Test one: Do changes in parameter values cause changes in the returned log-likelihood?</a></li>
<li class="chapter" data-level="3.8.2" data-path="forstmannChapter.html"><a href="forstmannChapter.html#testing-whether-data-generating-parameter-values-have-the-highest-likelihood"><i class="fa fa-check"></i><b>3.8.2</b> Testing whether data generating parameter values have the highest likelihood</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><i class="fa fa-check"></i><b>4</b> PMwG sampler with the Linear Ballistic Accumulator and a complex experiment design</a>
<ul>
<li class="chapter" data-level="4.1" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#the-lba-log-likelihood-function-for-the-wagenmakers-data-set"><i class="fa fa-check"></i><b>4.1</b> The LBA log-likelihood function for the Wagenmakers data set</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#what-is-a-log-likelihood-function-1"><i class="fa fa-check"></i><b>4.1.1</b> What is a log-likelihood function?</a></li>
<li class="chapter" data-level="4.1.2" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#writing-the-lba-log-likelihood-for-the-wagenmakers-data-set"><i class="fa fa-check"></i><b>4.1.2</b> Writing the LBA log-likelihood for the Wagenmakers data set</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#wagFastll"><i class="fa fa-check"></i><b>4.2</b> Fast LBA Log-likelihood function</a></li>
<li class="chapter" data-level="4.3" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#pmwg-framework-1"><i class="fa fa-check"></i><b>4.3</b> PMwG Framework</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="forstmannChapter.html"><a href="forstmannChapter.html#run-sampler"><i class="fa fa-check"></i><b>4.3.1</b> Running the sampler</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#genppdataWag"><i class="fa fa-check"></i><b>4.4</b> Simulating Posterior Predictive Data</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#assessing-descriptive-adequacy-goodness-of-fit-1"><i class="fa fa-check"></i><b>4.4.1</b> Assessing Descriptive Adequacy (goodness of fit)</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html"><a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html#model-comparison-via-dic"><i class="fa fa-check"></i><b>4.5</b> Model Comparison via DIC</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><i class="fa fa-check"></i><b>5</b> Estimating the Marginal Likelihood via Importance Sampling (IS<sup>2</sup>)</a>
<ul>
<li class="chapter" data-level="5.1" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#using-is2-with-the-forstmann-dataset"><i class="fa fa-check"></i><b>5.1</b> Using IS2 with the Forstmann dataset</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#load-packages-and-samples"><i class="fa fa-check"></i><b>5.1.1</b> Load packages and samples</a></li>
<li class="chapter" data-level="5.1.2" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#set-up-variables"><i class="fa fa-check"></i><b>5.1.2</b> Set up variables</a></li>
<li class="chapter" data-level="5.1.3" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#store-the-samples"><i class="fa fa-check"></i><b>5.1.3</b> Store the samples</a></li>
<li class="chapter" data-level="5.1.4" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#estimate-the-normal-mix"><i class="fa fa-check"></i><b>5.1.4</b> Estimate the normal mix</a></li>
<li class="chapter" data-level="5.1.5" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#generate-proposal-parameters-from-importance-samples"><i class="fa fa-check"></i><b>5.1.5</b> Generate proposal parameters from importance samples</a></li>
<li class="chapter" data-level="5.1.6" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-group-distribution-function"><i class="fa fa-check"></i><b>5.1.6</b> Write a group distribution function</a></li>
<li class="chapter" data-level="5.1.7" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-prior-distribution-function"><i class="fa fa-check"></i><b>5.1.7</b> Write a prior distribution function</a></li>
<li class="chapter" data-level="5.1.8" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-get_logp-function"><i class="fa fa-check"></i><b>5.1.8</b> Write a <code>get_logp</code> function</a></li>
<li class="chapter" data-level="5.1.9" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#compute-the-log-weights"><i class="fa fa-check"></i><b>5.1.9</b> Compute the Log Weights</a></li>
<li class="chapter" data-level="5.1.10" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#make-it-work"><i class="fa fa-check"></i><b>5.1.10</b> Make it work</a></li>
<li class="chapter" data-level="5.1.11" data-path="estimating-the-marginal-likelihood-via-importance-sampling-is2.html"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#bootstrapping-for-se"><i class="fa fa-check"></i><b>5.1.11</b> Bootstrapping for SE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="troubleshoot.html"><a href="troubleshoot.html"><i class="fa fa-check"></i><b>6</b> Troubleshooting PMwG errors</a>
<ul>
<li class="chapter" data-level="6.1" data-path="troubleshoot.html"><a href="troubleshoot.html#writing-your-log-likelihood-function-tips-errors-and-check-list"><i class="fa fa-check"></i><b>6.1</b> Writing your log-likelihood function: Tips, errors and check list</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>7</b> Appendix</a>
<ul>
<li class="chapter" data-level="7.1" data-path="appendix.html"><a href="appendix.html#wagSDTscript"><i class="fa fa-check"></i><b>7.1</b> Wagenmakers SDT script</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://newcastlecl.org/" target="blank">Published by Newcastle Cognition Lab</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Particle Based Samplers for MCMC</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimating-the-marginal-likelihood-via-importance-sampling-is2" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Estimating the Marginal Likelihood via Importance Sampling (IS<sup>2</sup>)<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#estimating-the-marginal-likelihood-via-importance-sampling-is2" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In <a href="forstmannChapter.html#forstMC">chapter 3</a>, we outlined two model comparison methods (i.e. graphical and information criterion) to determine the “<i>best fitting</i>” models for the Forstmann dataset. However, the current gold standard for model selection/comparison is to use marginal likelihood with Bayes factors. In this chapter we will illustrate how you can <a href="https://link.springer.com/article/10.3758/s13428-020-01348-w">estimate marginal likelihood via importance sampling squared (IS2)</a>. The IS2 method is a robust estimation method that accounts for model flexibility and provides unbiased estimates of the marginal likelihood. Marginal likelihood estimates allow you to assess the fit of a model and the model’s flexibility by integrating the likelihood across the prior predictive space of a model. In hierarchical models, obtaining the marginal likelihood is difficult, as the likelihood function is the density of the data with the random effects integrated out when viewed as a function of the group-level parameters; an integral which is often unavailable (computationally or as it is intractable). Despite this integral being intractable, IS2 allows a method of estimating the marginal likelihood when the likelihood is intractable but can be estimated without bias.</p>
<p>The method works by first sampling from the posterior via a sampling scheme such as MCMC (or here, PMwG). These draws are then used to create the importance distribution for the fixed parameters. This importance distribution is constructed by fitting a mixture of normal or Student t distributions to these MCMC samples. We then construct conditional proposal parameters - called particles - for each subject. The marginal likelihood is then estimated in an unbiased manner which is combined with the importance distribution. From this method, the importance sampling procedure is in itself an importance sampling procedure which can be used to estimate the likelihood.</p>
<div id="using-is2-with-the-forstmann-dataset" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Using IS2 with the Forstmann dataset<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#using-is2-with-the-forstmann-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here we will demonstrate how to use the IS2 algorithm to compare models from the Forstmann example in <a href="forstmannChapter.html#forstmannChapter">Chapter 3</a>. In the example shown here, we use samples taken from the two Forstmann (2008) models shown in chapter 3. We use samples from the PMwG posterior sampling stage (the <code>sampled</code> object). IS2 is robust enough to be able to use samples from any stage of PMwG; however, we recommend sampling from the posterior for lower variance.</p>
<p>In this example we run IS2 to compare the four models in an unbiased manner. The <a href="https://link.springer.com/article/10.3758/s13428-020-01348-w">IS2 paper</a> uses the same method, and so this chapter provides a walk-through of that example. As we are using samples from the PMwG algorithm, the <code>prior_dist</code> function is specifically coded for PMwG priors. To run other models, the <code>prior_dist</code> function needs to be updated (more on this later maybe).</p>
<div id="load-packages-and-samples" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Load packages and samples<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#load-packages-and-samples" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First we load the required packages and set up the environment, including the number of CPUs to use and the sampled object.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-1" tabindex="-1"></a><span class="co"># Load and install required packages</span></span>
<span id="cb109-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-2" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb109-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-3" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;mvtnorm&quot;</span>, <span class="st">&quot;MCMCpack&quot;</span>, <span class="st">&quot;rtdists&quot;</span>, <span class="st">&quot;invgamma&quot;</span>,</span>
<span id="cb109-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-4" tabindex="-1"></a>          <span class="st">&quot;mixtools&quot;</span>, <span class="st">&quot;condMVNorm&quot;</span>, <span class="st">&quot;parallel&quot;</span>)</span>
<span id="cb109-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-5" tabindex="-1"></a><span class="cf">for</span> (pkg <span class="cf">in</span> pkgs){</span>
<span id="cb109-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(pkg, <span class="at">character.only =</span> T)){</span>
<span id="cb109-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-7" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg)</span>
<span id="cb109-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-8" tabindex="-1"></a>    <span class="fu">library</span>(pkg)</span>
<span id="cb109-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-9" tabindex="-1"></a>  }</span>
<span id="cb109-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-10" tabindex="-1"></a>}</span>
<span id="cb109-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-11" tabindex="-1"></a></span>
<span id="cb109-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-12" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;forstmannM1_sampled.Rdata&quot;</span>)</span>
<span id="cb109-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb109-13" tabindex="-1"></a>cpus <span class="ot">=</span> <span class="dv">32</span></span></code></pre></div>
</div>
<div id="set-up-variables" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Set up variables<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#set-up-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we set up the variables to be used by the algorithm. With PMwG these can remain as specified here. Essentially the algorithm needs the number of subjects, random effects, iterations of samples, number of required IS2 samples, number of IS2 particles and the parameter names. Here, for convenience we use 1000 samples and 250 particles. It is often more reliable to run a larger number of samples and particles, however, this decreases efficiency. We recommend reading blog post for more information. We also recommend running the IS2 algorithm for several iterations and combining the IS2 samples output to achieve more stable estimates.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-1" tabindex="-1"></a><span class="co"># Set up variables for IS2 </span></span>
<span id="cb110-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-2" tabindex="-1"></a><span class="co"># Get some properties of the sampled object</span></span>
<span id="cb110-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-3" tabindex="-1"></a></span>
<span id="cb110-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-4" tabindex="-1"></a><span class="co"># Number of random effects</span></span>
<span id="cb110-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-5" tabindex="-1"></a>n_randeffect <span class="ot">&lt;-</span> sampled<span class="sc">$</span>n_pars</span>
<span id="cb110-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-6" tabindex="-1"></a><span class="co"># Number of subjects</span></span>
<span id="cb110-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-7" tabindex="-1"></a>n_subjects <span class="ot">&lt;-</span> sampled<span class="sc">$</span>n_subjects</span>
<span id="cb110-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-8" tabindex="-1"></a><span class="co"># Number of sample iterations</span></span>
<span id="cb110-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-9" tabindex="-1"></a>n_iter <span class="ot">&lt;-</span> <span class="fu">length</span>(sampled<span class="sc">$</span>samples<span class="sc">$</span>stage[sampled<span class="sc">$</span>samples<span class="sc">$</span>stage<span class="sc">==</span><span class="st">&quot;sample&quot;</span>])</span>
<span id="cb110-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-10" tabindex="-1"></a><span class="co"># Length of the full transformed random effect vector and/or parameter vector</span></span>
<span id="cb110-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-11" tabindex="-1"></a>length_draws <span class="ot">&lt;-</span> sampled<span class="sc">$</span>samples<span class="sc">$</span>idx</span>
<span id="cb110-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-12" tabindex="-1"></a><span class="co"># Number of importance samples</span></span>
<span id="cb110-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-13" tabindex="-1"></a>IS_samples <span class="ot">&lt;-</span> <span class="dv">1000</span> </span>
<span id="cb110-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-14" tabindex="-1"></a><span class="co"># Number of particles</span></span>
<span id="cb110-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-15" tabindex="-1"></a>n_particles <span class="ot">&lt;-</span> <span class="dv">250</span> </span>
<span id="cb110-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-16" tabindex="-1"></a><span class="co"># Parameter values</span></span>
<span id="cb110-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb110-17" tabindex="-1"></a>pars <span class="ot">&lt;-</span> sampled<span class="sc">$</span>pars</span></code></pre></div>
</div>
<div id="store-the-samples" class="section level3 hasAnchor" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Store the samples<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#store-the-samples" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this next step, we store the outputs from PMwG to be used in the IS2 algorithm. This leads to us creating <code>X</code>, an array of all parameters, random effects, off diagonal covariances and a-half values used in the PMwG sampling by the length of posterior samples.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-1" tabindex="-1"></a><span class="co"># Store the random effects from the sampled stage of PMwG object</span></span>
<span id="cb111-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-2" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> sampled<span class="sc">$</span>samples<span class="sc">$</span>alpha[,, sampled<span class="sc">$</span>samples<span class="sc">$</span>stage <span class="sc">==</span> <span class="st">&quot;sample&quot;</span>]</span>
<span id="cb111-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-3" tabindex="-1"></a></span>
<span id="cb111-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-4" tabindex="-1"></a><span class="co"># Store theta mu from the sampled stage of PMwG object</span></span>
<span id="cb111-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-5" tabindex="-1"></a>theta <span class="ot">&lt;-</span> sampled<span class="sc">$</span>samples<span class="sc">$</span>theta_mu[, sampled<span class="sc">$</span>samples<span class="sc">$</span>stage <span class="sc">==</span> <span class="st">&quot;sample&quot;</span>]</span>
<span id="cb111-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-6" tabindex="-1"></a></span>
<span id="cb111-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-7" tabindex="-1"></a><span class="co"># Store the Cholesky transformed sigma from the sampled stage of PMwG object</span></span>
<span id="cb111-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-8" tabindex="-1"></a>sig <span class="ot">&lt;-</span> sampled<span class="sc">$</span>samples<span class="sc">$</span>theta_sig[,, sampled<span class="sc">$</span>samples<span class="sc">$</span>stage <span class="sc">==</span> <span class="st">&quot;sample&quot;</span>]</span>
<span id="cb111-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-9" tabindex="-1"></a></span>
<span id="cb111-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-10" tabindex="-1"></a><span class="co"># The a-half is used when calculating the Huang and Wand (2013) prior. </span></span>
<span id="cb111-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-11" tabindex="-1"></a><span class="co"># The &#39;a&#39; is a random sample from the inverse gamma which weights the inverse Wishart. The mix of inverse Wisharts is the prior on the correlation matrix</span></span>
<span id="cb111-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-12" tabindex="-1"></a>a_half <span class="ot">&lt;-</span> <span class="fu">log</span>(sampled<span class="sc">$</span>samples<span class="sc">$</span>a_half[, sampled<span class="sc">$</span>samples<span class="sc">$</span>stage <span class="sc">==</span> <span class="st">&quot;sample&quot;</span>])</span>
<span id="cb111-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-13" tabindex="-1"></a></span>
<span id="cb111-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-14" tabindex="-1"></a></span>
<span id="cb111-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-15" tabindex="-1"></a></span>
<span id="cb111-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-16" tabindex="-1"></a><span class="co"># unwind function </span></span>
<span id="cb111-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-17" tabindex="-1"></a>unwind <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">reverse =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb111-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-18" tabindex="-1"></a></span>
<span id="cb111-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-19" tabindex="-1"></a>  <span class="cf">if</span> (reverse) {</span>
<span id="cb111-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-20" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">length</span>(x) <span class="sc">+</span> <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">0.5</span> <span class="do">## Dimensions of matrix</span></span>
<span id="cb111-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-21" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n, n))</span>
<span id="cb111-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-22" tabindex="-1"></a>    out[<span class="fu">lower.tri</span>(out, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">=</span> x</span>
<span id="cb111-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-23" tabindex="-1"></a>    <span class="fu">diag</span>(out) <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">diag</span>(out))</span>
<span id="cb111-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-24" tabindex="-1"></a>    out <span class="ot">=</span> out<span class="sc">%*%</span><span class="fu">t</span>(out)</span>
<span id="cb111-25"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-25" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb111-26"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-26" tabindex="-1"></a>    y <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">chol</span>(x))</span>
<span id="cb111-27"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-27" tabindex="-1"></a>    <span class="fu">diag</span>(y) <span class="ot">=</span> <span class="fu">log</span>(<span class="fu">diag</span>(y))</span>
<span id="cb111-28"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-28" tabindex="-1"></a>    out <span class="ot">=</span> y[<span class="fu">lower.tri</span>(y,<span class="at">diag=</span><span class="cn">TRUE</span>)]</span>
<span id="cb111-29"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-29" tabindex="-1"></a>  }</span>
<span id="cb111-30"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-30" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb111-31"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-31" tabindex="-1"></a>}</span>
<span id="cb111-32"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-32" tabindex="-1"></a></span>
<span id="cb111-33"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-33" tabindex="-1"></a><span class="co">#unwound sigma</span></span>
<span id="cb111-34"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-34" tabindex="-1"></a>pts2.unwound <span class="ot">&lt;-</span> <span class="fu">apply</span>(sig, <span class="dv">3</span>, unwind)</span>
<span id="cb111-35"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-35" tabindex="-1"></a></span>
<span id="cb111-36"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-36" tabindex="-1"></a>n.params <span class="ot">&lt;-</span> <span class="fu">nrow</span>(pts2.unwound) <span class="sc">+</span> n_randeffect <span class="sc">+</span> n_randeffect</span>
<span id="cb111-37"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-37" tabindex="-1"></a>all_samples <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(n_subjects, n.params, n_iter))</span>
<span id="cb111-38"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-38" tabindex="-1"></a>mu_tilde <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(n_subjects, n.params))</span>
<span id="cb111-39"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-39" tabindex="-1"></a>sigma_tilde <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(n_subjects, n.params, n.params))</span>
<span id="cb111-40"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-40" tabindex="-1"></a></span>
<span id="cb111-41"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-41" tabindex="-1"></a></span>
<span id="cb111-42"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-42" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_subjects){</span>
<span id="cb111-43"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-43" tabindex="-1"></a>  all_samples[j,,] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(alpha[,j,], theta[,], pts2.unwound[,])</span>
<span id="cb111-44"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-44" tabindex="-1"></a>  <span class="co"># Calculate the mean for re, mu and sigma</span></span>
<span id="cb111-45"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-45" tabindex="-1"></a>  mu_tilde[j,] <span class="ot">&lt;-</span> <span class="fu">apply</span>(all_samples[j,,], <span class="dv">1</span>, mean)</span>
<span id="cb111-46"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-46" tabindex="-1"></a>  <span class="co"># Calculate the covariance matrix for random effects, mu and sigma</span></span>
<span id="cb111-47"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-47" tabindex="-1"></a>  sigma_tilde[j,,] <span class="ot">&lt;-</span> <span class="fu">cov</span>(<span class="fu">t</span>(all_samples[j,,]))</span>
<span id="cb111-48"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-48" tabindex="-1"></a>}</span>
<span id="cb111-49"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-49" tabindex="-1"></a></span>
<span id="cb111-50"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb111-50" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">t</span>(theta), <span class="fu">t</span>(pts2.unwound), <span class="fu">t</span>(a_half)) </span></code></pre></div>
</div>
<div id="estimate-the-normal-mix" class="section level3 hasAnchor" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Estimate the normal mix<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#estimate-the-normal-mix" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we create an importance distribution by using a mixture of two Gaussian distributions, however this can be done differently. This takes ages.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-1" tabindex="-1"></a><span class="co"># do k=2, for a mixture of 2 gaussians</span></span>
<span id="cb112-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-2" tabindex="-1"></a><span class="co"># Number of distributions</span></span>
<span id="cb112-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-3" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">2</span> </span>
<span id="cb112-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-4" tabindex="-1"></a></span>
<span id="cb112-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-5" tabindex="-1"></a><span class="co">#mvnormalmixEM is a weak point - function can fail. needs a note or output to show if it doesn&#39;t work. Should restart if it fails</span></span>
<span id="cb112-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-6" tabindex="-1"></a>mix <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb112-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-7" tabindex="-1"></a><span class="cf">while</span>(<span class="fu">is.null</span>(mix)) {</span>
<span id="cb112-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-8" tabindex="-1"></a>  <span class="fu">tryCatch</span>(mix<span class="ot">&lt;-</span><span class="fu">mvnormalmixEM</span>(X,<span class="at">k=</span>k, <span class="at">maxit =</span> <span class="dv">5000</span>),<span class="at">error=</span><span class="cf">function</span>(e){</span>
<span id="cb112-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-9" tabindex="-1"></a>  },<span class="at">finally=</span>{})</span>
<span id="cb112-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-10" tabindex="-1"></a>}</span>
<span id="cb112-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-11" tabindex="-1"></a></span>
<span id="cb112-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-12" tabindex="-1"></a></span>
<span id="cb112-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-13" tabindex="-1"></a>mix_weight <span class="ot">&lt;-</span> mix<span class="sc">$</span>lambda</span>
<span id="cb112-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-14" tabindex="-1"></a>mix_mu <span class="ot">&lt;-</span> mix<span class="sc">$</span>mu</span>
<span id="cb112-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb112-15" tabindex="-1"></a>mix_sigma <span class="ot">&lt;-</span> mix<span class="sc">$</span>sigma</span></code></pre></div>
</div>
<div id="generate-proposal-parameters-from-importance-samples" class="section level3 hasAnchor" number="5.1.5">
<h3><span class="header-section-number">5.1.5</span> Generate proposal parameters from importance samples<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#generate-proposal-parameters-from-importance-samples" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we have our importance distribution, we can generate proposals from this. Here, we protect against low amounts of samples by including the <code>pmax</code> and <code>pmin</code> arguments, ensuring that even if the weights are low, that we do sample from the both parts of the mixture.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-1" tabindex="-1"></a><span class="co"># Generate the proposal parameters from the mix of importance samples</span></span>
<span id="cb113-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-2" tabindex="-1"></a><span class="co"># Use the weight to get samples for n1. n2 = samples-n1 (i.e 9000 and 1000)</span></span>
<span id="cb113-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-3" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>,</span>
<span id="cb113-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-4" tabindex="-1"></a>             <span class="at">size =</span> IS_samples,</span>
<span id="cb113-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-5" tabindex="-1"></a>             <span class="at">prob =</span> <span class="fu">max</span>(mix_weight)</span>
<span id="cb113-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-6" tabindex="-1"></a>             )</span>
<span id="cb113-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-7" tabindex="-1"></a></span>
<span id="cb113-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-8" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="fu">pmax</span>(n1, <span class="dv">2</span>)</span>
<span id="cb113-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-9" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(n1, IS_samples <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb113-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-10" tabindex="-1"></a>n2 <span class="ot">&lt;-</span> IS_samples <span class="sc">-</span> n1</span>
<span id="cb113-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-11" tabindex="-1"></a></span>
<span id="cb113-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-12" tabindex="-1"></a><span class="co"># Generate the 10,000 IS proposals given the mix</span></span>
<span id="cb113-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-13" tabindex="-1"></a>proposals1 <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(n1, </span>
<span id="cb113-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-14" tabindex="-1"></a>                      mix_mu[[<span class="dv">1</span>]],</span>
<span id="cb113-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-15" tabindex="-1"></a>                      mix_sigma[[<span class="dv">1</span>]]</span>
<span id="cb113-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-16" tabindex="-1"></a>                      )</span>
<span id="cb113-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-17" tabindex="-1"></a></span>
<span id="cb113-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-18" tabindex="-1"></a>proposals2 <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(n2,</span>
<span id="cb113-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-19" tabindex="-1"></a>                      mix_mu[[<span class="dv">2</span>]],</span>
<span id="cb113-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-20" tabindex="-1"></a>                      mix_sigma[[<span class="dv">2</span>]]</span>
<span id="cb113-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-21" tabindex="-1"></a>                      )</span>
<span id="cb113-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-22" tabindex="-1"></a></span>
<span id="cb113-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb113-23" tabindex="-1"></a>prop_theta <span class="ot">&lt;-</span> <span class="fu">rbind</span>(proposals1, proposals2)</span></code></pre></div>
</div>
<div id="write-a-group-distribution-function" class="section level3 hasAnchor" number="5.1.6">
<h3><span class="header-section-number">5.1.6</span> Write a group distribution function<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-group-distribution-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This function is used in the IS2 algorithm, however, it will vary with the type of priors that are set. For PMwG we use a multivariate normal prior and so here we calculate the density using <code>dmvnorm</code>. The density is calculated for the current random effect particle given the group level parameters and variance.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-1" tabindex="-1"></a>groupdist <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">random_effect =</span> <span class="cn">NULL</span>,</span>
<span id="cb114-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-2" tabindex="-1"></a>                       parameters,</span>
<span id="cb114-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-3" tabindex="-1"></a>                       <span class="at">sample =</span> <span class="cn">FALSE</span>,</span>
<span id="cb114-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-4" tabindex="-1"></a>                       <span class="at">n_samples =</span> <span class="cn">NULL</span>,</span>
<span id="cb114-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-5" tabindex="-1"></a>                       n_randeffect){</span>
<span id="cb114-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-6" tabindex="-1"></a>  param.theta.mu <span class="ot">&lt;-</span> parameters[<span class="dv">1</span><span class="sc">:</span>n_randeffect]</span>
<span id="cb114-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-7" tabindex="-1"></a>  <span class="co"># Scott would like it to ask for n(unwind) rather than doing the calculation</span></span>
<span id="cb114-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-8" tabindex="-1"></a>  <span class="co"># for how many it actually needs, you should just input the length of the unwound object</span></span>
<span id="cb114-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-9" tabindex="-1"></a>  param.theta.sig.unwound <span class="ot">&lt;-</span> parameters[(n_randeffect <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">length</span>(parameters) <span class="sc">-</span> n_randeffect)] </span>
<span id="cb114-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-10" tabindex="-1"></a>  param.theta.sig2 <span class="ot">&lt;-</span> <span class="fu">unwind</span>(param.theta.sig.unwound,</span>
<span id="cb114-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-11" tabindex="-1"></a>                             <span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb114-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-12" tabindex="-1"></a>  <span class="cf">if</span> (sample){</span>
<span id="cb114-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-13" tabindex="-1"></a>    <span class="fu">return</span>(mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(n_samples,</span>
<span id="cb114-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-14" tabindex="-1"></a>                            param.theta.mu,</span>
<span id="cb114-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-15" tabindex="-1"></a>                            param.theta.sig2)</span>
<span id="cb114-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-16" tabindex="-1"></a>           )</span>
<span id="cb114-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-17" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb114-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-18" tabindex="-1"></a>    logw_second <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">dmvnorm</span>(random_effect,</span>
<span id="cb114-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-19" tabindex="-1"></a>                                    param.theta.mu,</span>
<span id="cb114-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-20" tabindex="-1"></a>                                    param.theta.sig2,</span>
<span id="cb114-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-21" tabindex="-1"></a>                                    <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb114-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-22" tabindex="-1"></a>    <span class="fu">return</span>(logw_second)</span>
<span id="cb114-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-23" tabindex="-1"></a>  }</span>
<span id="cb114-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb114-24" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="write-a-prior-distribution-function" class="section level3 hasAnchor" number="5.1.7">
<h3><span class="header-section-number">5.1.7</span> Write a prior distribution function<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-prior-distribution-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This function is used in PMwG to calculate the density under the prior. Here we use <a href="https://projecteuclid.org/journals/bayesian-analysis/volume-8/issue-2/Simple-Marginally-Noninformative-Prior-Distributions-for-Covariance-Matrices/10.1214/13-BA815.full">Huang and Wand’s (2013)</a> prior (as used in PMwG) for a multivariate normal. The final line shows the value that is returned, which is equation x in the paper. This takes the density of the current parameters under the prior mean (<code>log_prior_mu</code>), variance (<code>log_prior_sigma</code>) and variance on the variance (<code>log_prior_a</code>). There are several other calculations performed here, which can be found in the paper.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-1" tabindex="-1"></a>prior_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(parameters,</span>
<span id="cb115-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-2" tabindex="-1"></a>                       <span class="at">prior_parameters =</span> sampled<span class="sc">$</span>prior,</span>
<span id="cb115-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-3" tabindex="-1"></a>                       n_randeffect)</span>
<span id="cb115-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-4" tabindex="-1"></a>  {</span>
<span id="cb115-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-5" tabindex="-1"></a>  <span class="co">#mod notes: the sampled$prior needs to be fixed/passed in some other time</span></span>
<span id="cb115-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-6" tabindex="-1"></a>  param.theta.mu <span class="ot">&lt;-</span> parameters[<span class="dv">1</span><span class="sc">:</span>n_randeffect]</span>
<span id="cb115-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-7" tabindex="-1"></a>  param.theta.sig.unwound <span class="ot">&lt;-</span> parameters[(n_randeffect<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">length</span>(parameters)<span class="sc">-</span>n_randeffect)] <span class="co">#scott would like it to ask for n(unwind)</span></span>
<span id="cb115-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-8" tabindex="-1"></a>  param.theta.sig2 <span class="ot">&lt;-</span> <span class="fu">unwind</span>(param.theta.sig.unwound, <span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb115-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-9" tabindex="-1"></a>  param.a <span class="ot">&lt;-</span> <span class="fu">exp</span>(parameters[((<span class="fu">length</span>(parameters)<span class="sc">-</span>n_randeffect)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">length</span>(parameters))])</span>
<span id="cb115-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-10" tabindex="-1"></a>  v_alpha<span class="ot">=</span><span class="dv">2</span></span>
<span id="cb115-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-11" tabindex="-1"></a>  </span>
<span id="cb115-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-12" tabindex="-1"></a>  log_prior_mu <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">dmvnorm</span>(param.theta.mu, </span>
<span id="cb115-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-13" tabindex="-1"></a>                                   <span class="at">mean =</span> prior_parameters<span class="sc">$</span>theta_mu_mean,</span>
<span id="cb115-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-14" tabindex="-1"></a>                                   <span class="at">sigma =</span> prior_parameters<span class="sc">$</span>theta_mu_var,</span>
<span id="cb115-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-15" tabindex="-1"></a>                                   <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb115-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-16" tabindex="-1"></a>  log_prior_sigma <span class="ot">&lt;-</span> <span class="fu">log</span>(MCMCpack<span class="sc">::</span><span class="fu">diwish</span>(param.theta.sig2, <span class="at">v =</span> v_alpha <span class="sc">+</span> n_randeffect<span class="dv">-1</span>,</span>
<span id="cb115-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-17" tabindex="-1"></a>                                          <span class="at">S =</span> <span class="dv">2</span> <span class="sc">*</span> v_alpha <span class="sc">*</span> <span class="fu">diag</span>(<span class="dv">1</span> <span class="sc">/</span> param.a)))  <span class="co"># exp of a-half -&gt; positive only</span></span>
<span id="cb115-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-18" tabindex="-1"></a>  log_prior_a <span class="ot">&lt;-</span> <span class="fu">sum</span>(invgamma<span class="sc">::</span><span class="fu">dinvgamma</span>(param.a,</span>
<span id="cb115-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-19" tabindex="-1"></a>                                         <span class="at">scale =</span> <span class="fl">0.5</span>, </span>
<span id="cb115-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-20" tabindex="-1"></a>                                         <span class="at">shape =</span> <span class="dv">1</span>,</span>
<span id="cb115-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-21" tabindex="-1"></a>                                         <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb115-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-22" tabindex="-1"></a>  </span>
<span id="cb115-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-23" tabindex="-1"></a>  logw_den2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">log</span>(<span class="dv">1</span> <span class="sc">/</span> param.a)) <span class="co"># Jacobian determinant of transformation of log of the a-half</span></span>
<span id="cb115-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-24" tabindex="-1"></a>  logw_den3 <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">2</span><span class="sc">^</span>n_randeffect) <span class="sc">+</span> <span class="fu">sum</span>((n_randeffect<span class="sc">:</span><span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">diag</span>(param.theta.sig2))) <span class="co">#Jacobian determinant of Cholesky factors of covariance matrix</span></span>
<span id="cb115-25"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-25" tabindex="-1"></a>  <span class="fu">return</span>(log_prior_mu <span class="sc">+</span> log_prior_sigma <span class="sc">+</span> log_prior_a <span class="sc">+</span> logw_den3 <span class="sc">-</span> logw_den2)</span>
<span id="cb115-26"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb115-26" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="write-a-get_logp-function" class="section level3 hasAnchor" number="5.1.8">
<h3><span class="header-section-number">5.1.8</span> Write a <code>get_logp</code> function<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#write-a-get_logp-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we need to create the function used to calculate the density of each particle. This is Equation 5 in the paper. This function calculates the density of each proposal for each subject across n particles. Here we first generate the particles from a mix of the group level parameters and a conditional multivariate normal, conditioned on the current subjects mean and variance. We then obtain the density of these proposed parameters under the likelihood and the group_dist functions over the likelihood of these proposals (as per equation 5). We then protect against badness and return the sum of these values (summed across participants, where participants are summed across particles)</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-1" tabindex="-1"></a>get_logp <span class="ot">&lt;-</span> <span class="cf">function</span>(prop_theta,</span>
<span id="cb116-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-2" tabindex="-1"></a>                     data,</span>
<span id="cb116-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-3" tabindex="-1"></a>                     n_subjects,</span>
<span id="cb116-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-4" tabindex="-1"></a>                     n_particles,</span>
<span id="cb116-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-5" tabindex="-1"></a>                     n_randeffect,</span>
<span id="cb116-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-6" tabindex="-1"></a>                     mu_tilde,</span>
<span id="cb116-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-7" tabindex="-1"></a>                     sigma_tilde,</span>
<span id="cb116-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-8" tabindex="-1"></a>                     i,</span>
<span id="cb116-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-9" tabindex="-1"></a>                     <span class="at">group_dist =</span> group_dist)</span>
<span id="cb116-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-10" tabindex="-1"></a>  {</span>
<span id="cb116-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-11" tabindex="-1"></a>  <span class="co">#make an array for the density</span></span>
<span id="cb116-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-12" tabindex="-1"></a>  logp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(n_particles, n_subjects))</span>
<span id="cb116-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-13" tabindex="-1"></a>  <span class="co"># for each subject, get 1000 IS samples (particles) and find log weight of each</span></span>
<span id="cb116-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-14" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_subjects){</span>
<span id="cb116-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-15" tabindex="-1"></a>    <span class="co">#generate the particles from the conditional MVnorm AND mix of group level proposals</span></span>
<span id="cb116-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-16" tabindex="-1"></a>    wmix <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb116-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-17" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, </span>
<span id="cb116-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-18" tabindex="-1"></a>                 <span class="at">size =</span> n_particles,</span>
<span id="cb116-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-19" tabindex="-1"></a>                 <span class="at">prob =</span> wmix)</span>
<span id="cb116-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-20" tabindex="-1"></a>    <span class="cf">if</span> (n1 <span class="sc">&lt;</span> <span class="dv">2</span>) n1 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb116-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-21" tabindex="-1"></a>    <span class="cf">if</span> (n1 <span class="sc">&gt;</span> (n_particles <span class="sc">-</span> <span class="dv">2</span>)) n1 <span class="ot">&lt;-</span> n_particles <span class="sc">-</span> <span class="dv">2</span> <span class="do">## These just avoid degenerate arrays.</span></span>
<span id="cb116-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-22" tabindex="-1"></a>    n2 <span class="ot">&lt;-</span> n_particles <span class="sc">-</span> n1</span>
<span id="cb116-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-23" tabindex="-1"></a>    <span class="co"># do conditional MVnorm based on the proposal distribution</span></span>
<span id="cb116-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-24" tabindex="-1"></a>    conditional <span class="ot">&lt;-</span> condMVNorm<span class="sc">::</span><span class="fu">condMVN</span>(<span class="at">mean =</span> mu_tilde[j,],</span>
<span id="cb116-25"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-25" tabindex="-1"></a>                                       <span class="at">sigma =</span> sigma_tilde[j,,],</span>
<span id="cb116-26"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-26" tabindex="-1"></a>                                       <span class="at">dependent.ind =</span> <span class="dv">1</span><span class="sc">:</span>n_randeffect,</span>
<span id="cb116-27"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-27" tabindex="-1"></a>                          <span class="at">given.ind =</span> (n_randeffect <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n.params,</span>
<span id="cb116-28"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-28" tabindex="-1"></a>                          <span class="at">X.given =</span> prop_theta[i, <span class="dv">1</span><span class="sc">:</span>(n.params<span class="sc">-</span>n_randeffect)])</span>
<span id="cb116-29"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-29" tabindex="-1"></a>    particles1 <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(n1, </span>
<span id="cb116-30"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-30" tabindex="-1"></a>                                   conditional<span class="sc">$</span>condMean,</span>
<span id="cb116-31"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-31" tabindex="-1"></a>                                   conditional<span class="sc">$</span>condVar)</span>
<span id="cb116-32"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-32" tabindex="-1"></a>    <span class="co"># mix of proposal parameters and conditional</span></span>
<span id="cb116-33"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-33" tabindex="-1"></a>    particles2 <span class="ot">&lt;-</span> <span class="fu">group_dist</span>(<span class="at">n_samples =</span> n2,</span>
<span id="cb116-34"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-34" tabindex="-1"></a>                             <span class="at">parameters =</span> prop_theta[i,],</span>
<span id="cb116-35"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-35" tabindex="-1"></a>                             <span class="at">sample =</span> <span class="cn">TRUE</span>,</span>
<span id="cb116-36"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-36" tabindex="-1"></a>                             <span class="at">n_randeffect =</span> n_randeffect)</span>
<span id="cb116-37"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-37" tabindex="-1"></a>    particles <span class="ot">&lt;-</span> <span class="fu">rbind</span>(particles1, particles2)</span>
<span id="cb116-38"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-38" tabindex="-1"></a>    </span>
<span id="cb116-39"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-39" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_particles){</span>
<span id="cb116-40"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-40" tabindex="-1"></a>      x <span class="ot">&lt;-</span> particles[k,]</span>
<span id="cb116-41"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-41" tabindex="-1"></a>      <span class="co">#names for ll function to work</span></span>
<span id="cb116-42"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-42" tabindex="-1"></a>      <span class="co">#mod notes: this is the bit the prior effects</span></span>
<span id="cb116-43"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-43" tabindex="-1"></a>      <span class="fu">names</span>(x) <span class="ot">&lt;-</span> pars</span>
<span id="cb116-44"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-44" tabindex="-1"></a>      <span class="co">#   do lba log likelihood with given parameters for each subject, gets density of particle from ll func</span></span>
<span id="cb116-45"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-45" tabindex="-1"></a>      logw_first <span class="ot">&lt;-</span> sampled<span class="sc">$</span><span class="fu">ll_func</span>(x, </span>
<span id="cb116-46"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-46" tabindex="-1"></a>                                    <span class="at">data =</span> data[<span class="fu">as.numeric</span>(<span class="fu">factor</span>(data<span class="sc">$</span>subject))<span class="sc">==</span>j,]) <span class="co">#mod notes: do we pass this in or the whole sampled object????</span></span>
<span id="cb116-47"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-47" tabindex="-1"></a>      </span>
<span id="cb116-48"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-48" tabindex="-1"></a>      <span class="co"># below gets second part of equation 5 numerator i.e. density under prop_theta</span></span>
<span id="cb116-49"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-49" tabindex="-1"></a>      <span class="co"># particle k and big vector of things</span></span>
<span id="cb116-50"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-50" tabindex="-1"></a>      logw_second <span class="ot">&lt;-</span> <span class="fu">group_dist</span>(<span class="at">random_effect =</span> particles[k,],</span>
<span id="cb116-51"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-51" tabindex="-1"></a>                                <span class="at">parameters =</span> prop_theta[i,],</span>
<span id="cb116-52"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-52" tabindex="-1"></a>                                <span class="at">sample=</span> <span class="cn">FALSE</span>,</span>
<span id="cb116-53"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-53" tabindex="-1"></a>                                <span class="at">n_randeffect =</span> n_randeffect) <span class="co">#mod notes: group dist</span></span>
<span id="cb116-54"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-54" tabindex="-1"></a>      <span class="co"># below is the denominator - i.e. mix of density under conditional and density under pro_theta</span></span>
<span id="cb116-55"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-55" tabindex="-1"></a>      logw_third <span class="ot">&lt;-</span> <span class="fu">log</span>(wmix<span class="sc">*</span><span class="fu">dmvnorm</span>(particles[k,],</span>
<span id="cb116-56"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-56" tabindex="-1"></a>                                     conditional<span class="sc">$</span>condMean,</span>
<span id="cb116-57"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-57" tabindex="-1"></a>                                     conditional<span class="sc">$</span>condVar) <span class="sc">+</span> </span>
<span id="cb116-58"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-58" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">-</span>wmix) <span class="sc">*</span> <span class="fu">exp</span>(logw_second)) <span class="co">#mod notes: fine?</span></span>
<span id="cb116-59"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-59" tabindex="-1"></a>      <span class="co">#does equation 5</span></span>
<span id="cb116-60"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-60" tabindex="-1"></a>      logw <span class="ot">=</span> (logw_first <span class="sc">+</span> logw_second) <span class="sc">-</span> logw_third</span>
<span id="cb116-61"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-61" tabindex="-1"></a>      <span class="co">#assign to correct row/column</span></span>
<span id="cb116-62"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-62" tabindex="-1"></a>      logp[k,j] <span class="ot">=</span> logw </span>
<span id="cb116-63"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-63" tabindex="-1"></a>    }</span>
<span id="cb116-64"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-64" tabindex="-1"></a>  }</span>
<span id="cb116-65"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-65" tabindex="-1"></a>  <span class="co">#we use this part to centre the logw before adding back on at the end. This avoids inf and -inf values</span></span>
<span id="cb116-66"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-66" tabindex="-1"></a>  sub_max <span class="ot">=</span> <span class="fu">apply</span>(logp, <span class="dv">2</span>, max)</span>
<span id="cb116-67"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-67" tabindex="-1"></a>  logw <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">t</span>(logp) <span class="sc">-</span> sub_max)</span>
<span id="cb116-68"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-68" tabindex="-1"></a>  w <span class="ot">=</span> <span class="fu">exp</span>(logw)</span>
<span id="cb116-69"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-69" tabindex="-1"></a>  subj_logp <span class="ot">=</span> <span class="fu">log</span>(<span class="fu">apply</span>(w, <span class="dv">2</span>, mean)) <span class="sc">+</span> sub_max <span class="co">#means</span></span>
<span id="cb116-70"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-70" tabindex="-1"></a>  </span>
<span id="cb116-71"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-71" tabindex="-1"></a>  <span class="co"># sum the logp and return </span></span>
<span id="cb116-72"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-72" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(subj_logp))</span>
<span id="cb116-73"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb116-73" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="compute-the-log-weights" class="section level3 hasAnchor" number="5.1.9">
<h3><span class="header-section-number">5.1.9</span> Compute the Log Weights<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#compute-the-log-weights" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we need to create our <code>compute_lw</code> function. This function does equation 10 to obtain the log weights for the proposed particles. We first use <code>get_logp</code> to to get the density of the particles for each subject, then use prior_dist to get the density of the proposals under the prior. Finally we get the density of the proposed parameters under the mixture distribution. This then gives us equation 10.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-1" tabindex="-1"></a>compute_lw <span class="ot">&lt;-</span> <span class="cf">function</span>(prop_theta,</span>
<span id="cb117-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-2" tabindex="-1"></a>                       data,</span>
<span id="cb117-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-3" tabindex="-1"></a>                       n_subjects,</span>
<span id="cb117-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-4" tabindex="-1"></a>                       n_particles,</span>
<span id="cb117-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-5" tabindex="-1"></a>                       n_randeffect,</span>
<span id="cb117-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-6" tabindex="-1"></a>                       mu_tilde,</span>
<span id="cb117-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-7" tabindex="-1"></a>                       sigma_tilde,</span>
<span id="cb117-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-8" tabindex="-1"></a>                       i,</span>
<span id="cb117-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-9" tabindex="-1"></a>                       <span class="at">prior_dist =</span> prior_dist,</span>
<span id="cb117-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-10" tabindex="-1"></a>                       <span class="at">sampled =</span> sampled)</span>
<span id="cb117-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-11" tabindex="-1"></a>  {</span>
<span id="cb117-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-12" tabindex="-1"></a>  logp.out <span class="ot">&lt;-</span> <span class="fu">get_logp</span>(prop_theta,</span>
<span id="cb117-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-13" tabindex="-1"></a>                       data,</span>
<span id="cb117-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-14" tabindex="-1"></a>                       n_subjects,</span>
<span id="cb117-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-15" tabindex="-1"></a>                       n_particles,</span>
<span id="cb117-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-16" tabindex="-1"></a>                       n_randeffect,</span>
<span id="cb117-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-17" tabindex="-1"></a>                       mu_tilde,</span>
<span id="cb117-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-18" tabindex="-1"></a>                       sigma_tilde,</span>
<span id="cb117-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-19" tabindex="-1"></a>                       i,</span>
<span id="cb117-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-20" tabindex="-1"></a>                       <span class="at">group_dist =</span> group_dist)</span>
<span id="cb117-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-21" tabindex="-1"></a>  <span class="do">##do equation 10</span></span>
<span id="cb117-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-22" tabindex="-1"></a>  logw_num <span class="ot">&lt;-</span> logp.out[<span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb117-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-23" tabindex="-1"></a>    <span class="fu">prior_dist</span>(<span class="at">parameters =</span> prop_theta[i,],</span>
<span id="cb117-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-24" tabindex="-1"></a>               <span class="at">prior_parameters =</span> sampled<span class="sc">$</span>prior,</span>
<span id="cb117-25"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-25" tabindex="-1"></a>               n_randeffect</span>
<span id="cb117-26"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-26" tabindex="-1"></a>               )</span>
<span id="cb117-27"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-27" tabindex="-1"></a>  logw_den <span class="ot">&lt;-</span> <span class="fu">log</span>(mix_weight[<span class="dv">1</span>] <span class="sc">*</span> mvtnorm<span class="sc">::</span><span class="fu">dmvnorm</span>(prop_theta[i,],</span>
<span id="cb117-28"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-28" tabindex="-1"></a>                                                   mix_mu[[<span class="dv">1</span>]],</span>
<span id="cb117-29"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-29" tabindex="-1"></a>                                                   mix_sigma[[<span class="dv">1</span>]]) <span class="sc">+</span></span>
<span id="cb117-30"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-30" tabindex="-1"></a>                    mix_weight[<span class="dv">2</span>]<span class="sc">*</span> mvtnorm<span class="sc">::</span><span class="fu">dmvnorm</span>(prop_theta[i,],</span>
<span id="cb117-31"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-31" tabindex="-1"></a>                                                    mix_mu[[<span class="dv">2</span>]],</span>
<span id="cb117-32"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-32" tabindex="-1"></a>                                                    mix_sigma[[<span class="dv">2</span>]])</span>
<span id="cb117-33"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-33" tabindex="-1"></a>                  ) <span class="co">#density of proposed params under the means</span></span>
<span id="cb117-34"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-34" tabindex="-1"></a>  logw <span class="ot">&lt;-</span> logw_num <span class="sc">-</span> logw_den <span class="co">#this is the equation 10</span></span>
<span id="cb117-35"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-35" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(logw))</span>
<span id="cb117-36"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-36" tabindex="-1"></a>  <span class="co">#NOTE: we should leave a note if variance is bad - variance is given by the logp function (currently commented out)</span></span>
<span id="cb117-37"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb117-37" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="make-it-work" class="section level3 hasAnchor" number="5.1.10">
<h3><span class="header-section-number">5.1.10</span> Make it work<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#make-it-work" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we have to run it, see code below;</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-1" tabindex="-1"></a><span class="co">#makes an array to store the IS samples</span></span>
<span id="cb118-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-2" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(IS_samples))</span>
<span id="cb118-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-3" tabindex="-1"></a></span>
<span id="cb118-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-4" tabindex="-1"></a><span class="co">#do the sampling</span></span>
<span id="cb118-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-5" tabindex="-1"></a><span class="cf">if</span> (cpus<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb118-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-6" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(<span class="at">X=</span><span class="dv">1</span><span class="sc">:</span>IS_samples,</span>
<span id="cb118-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-7" tabindex="-1"></a>                  <span class="at">mc.cores =</span> cpus,</span>
<span id="cb118-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-8" tabindex="-1"></a>                  <span class="at">FUN =</span> compute_lw,</span>
<span id="cb118-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-9" tabindex="-1"></a>                  <span class="at">prop_theta =</span> prop_theta,</span>
<span id="cb118-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-10" tabindex="-1"></a>                  <span class="at">data =</span> data,</span>
<span id="cb118-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-11" tabindex="-1"></a>                  <span class="at">n_subjects=</span> n_subjects,</span>
<span id="cb118-12"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-12" tabindex="-1"></a>                  <span class="at">n_particles =</span> n_particles,</span>
<span id="cb118-13"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-13" tabindex="-1"></a>                  <span class="at">n_randeffect =</span> n_randeffect,</span>
<span id="cb118-14"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-14" tabindex="-1"></a>                  <span class="at">mu_tilde=</span>mu_tilde,</span>
<span id="cb118-15"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-15" tabindex="-1"></a>                  <span class="at">sigma_tilde =</span> sigma_tilde,</span>
<span id="cb118-16"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-16" tabindex="-1"></a>                  <span class="at">prior_dist =</span> prior_dist,</span>
<span id="cb118-17"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-17" tabindex="-1"></a>                  <span class="at">sampled =</span> sampled)</span>
<span id="cb118-18"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-18" tabindex="-1"></a>} <span class="cf">else</span>{</span>
<span id="cb118-19"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-19" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>IS_samples){</span>
<span id="cb118-20"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-20" tabindex="-1"></a>    <span class="fu">cat</span>(i)</span>
<span id="cb118-21"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-21" tabindex="-1"></a>    tmp[i] <span class="ot">&lt;-</span> <span class="fu">compute_lw</span>(prop_theta,</span>
<span id="cb118-22"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-22" tabindex="-1"></a>                         data,</span>
<span id="cb118-23"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-23" tabindex="-1"></a>                         n_subjects,</span>
<span id="cb118-24"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-24" tabindex="-1"></a>                         n_particles,</span>
<span id="cb118-25"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-25" tabindex="-1"></a>                         n_randeffect,</span>
<span id="cb118-26"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-26" tabindex="-1"></a>                         mu_tilde,</span>
<span id="cb118-27"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-27" tabindex="-1"></a>                         sigma_tilde,</span>
<span id="cb118-28"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-28" tabindex="-1"></a>                         i,</span>
<span id="cb118-29"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-29" tabindex="-1"></a>                         <span class="at">prior_dist =</span> prior_dist,</span>
<span id="cb118-30"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-30" tabindex="-1"></a>                         <span class="at">sampled =</span> sampled)</span>
<span id="cb118-31"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-31" tabindex="-1"></a>  }</span>
<span id="cb118-32"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-32" tabindex="-1"></a>}</span>
<span id="cb118-33"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-33" tabindex="-1"></a></span>
<span id="cb118-34"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-34" tabindex="-1"></a></span>
<span id="cb118-35"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-35" tabindex="-1"></a><span class="co"># get the ML value</span></span>
<span id="cb118-36"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-36" tabindex="-1"></a>finished <span class="ot">&lt;-</span> tmp</span>
<span id="cb118-37"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-37" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">unlist</span>(tmp)</span>
<span id="cb118-38"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-38" tabindex="-1"></a>max.lw <span class="ot">&lt;-</span> <span class="fu">max</span>(tmp)</span>
<span id="cb118-39"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-39" tabindex="-1"></a>mean.centred.lw <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(tmp <span class="sc">-</span> max.lw)) <span class="co">#takes off the max and gets mean (avoids infinities)</span></span>
<span id="cb118-40"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb118-40" tabindex="-1"></a>lw <span class="ot">&lt;-</span><span class="fu">log</span>(mean.centred.lw) <span class="sc">+</span> max.lw <span class="co">#puts max back on to get the lw</span></span></code></pre></div>
</div>
<div id="bootstrapping-for-se" class="section level3 hasAnchor" number="5.1.11">
<h3><span class="header-section-number">5.1.11</span> Bootstrapping for SE<a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#bootstrapping-for-se" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To calculate standard error, we use a bootstrapping method, which can be done using the code below.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-1" tabindex="-1"></a>bootstrap <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb119-2"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-2" tabindex="-1"></a>log_marglik_boot <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> bootstrap)</span>
<span id="cb119-3"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-3" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>bootstrap){</span>
<span id="cb119-4"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-4" tabindex="-1"></a>  log_weight_boot <span class="ot">&lt;-</span> <span class="fu">sample</span>(tmp,</span>
<span id="cb119-5"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-5" tabindex="-1"></a>                            IS_samples,</span>
<span id="cb119-6"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-6" tabindex="-1"></a>                            <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="co">#resample with replacement from the lw</span></span>
<span id="cb119-7"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-7" tabindex="-1"></a>  max.boot <span class="ot">&lt;-</span> <span class="fu">max</span>(log_weight_boot)</span>
<span id="cb119-8"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-8" tabindex="-1"></a>  centred.boot <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(log_weight_boot <span class="sc">-</span> max.boot)) <span class="co">#takes off the max and gets mean (avoids infinities)</span></span>
<span id="cb119-9"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-9" tabindex="-1"></a>  log_marglik_boot[i] <span class="ot">&lt;-</span> <span class="fu">log</span>(centred.boot) <span class="sc">+</span> max.boot <span class="co">#puts max back on </span></span>
<span id="cb119-10"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-10" tabindex="-1"></a>}</span>
<span id="cb119-11"><a href="estimating-the-marginal-likelihood-via-importance-sampling-is2.html#cb119-11" tabindex="-1"></a><span class="fu">var</span>(log_marglik_boot) <span class="do">###SE</span></span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="pmwg-sampler-with-the-linear-ballistic-accumulator-and-a-complex-experiment-design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="troubleshoot.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/rstudio/bookdown-demo/edit/master/04-IS2.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["PMwG-Sampler-Tutorial.pdf", "PMwG-Sampler-Tutorial.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
